@using Jas.Helpers
@using Jas.Globals.Ptg.Enums
@model Jas.Areas.Ptg.Pages.PlateContentVm


@{
    if (Model.StandType != (int)StandType.Plate)
    {
        <h1>@Model.StandCode - @Model.StandName</h1>
    }
    else
    {
        <h2>@Model.PlateIndex. @Model.PlateDescription</h2>
    }
}

<style>
.image-hover {
    position: relative;
    overflow: hidden;
    min-height: 100px; /* 🔸 nastav minimální výšku */
}

.image-hover img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* 🔸 roztáhne obrázek, aby vyplnil celý prostor */
    transition: transform 0.3s ease;
}

.image-hover:hover img {
    transform: scale(1.05);
}

.image-hover .overlay {
/*     position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
 */    background: rgba(0, 0, 0, 0.6);
    color: white;
    text-align: center;
    opacity: 1;
    transition: opacity 0.3s ease;
    padding: 0.5rem;
    font-size: 0.8rem;
    border-bottom-left-radius: .5rem;
    border-bottom-right-radius: .5rem;
    line-height: 1.3;
}

.image-hover:hover .overlay {
    opacity: 1;
}
</style>

<div id="plate-meta" data-plate="@Model.PlateIndex" data-total="@Model.TotalPlates"></div>

<div class="row">
    <!-- Obrázek + navigace -->
    <div class="col-md-4 text-center mb-4">

        <div class="plate-zoom mx-auto shadow rounded"
             role="img"
             aria-label="Obrázek plata"
             data-img="@Model.ImgUrl"
             style="
                max-height: 600px;
                height: 60vh;
                background-image: url('@Model.ImgUrl');
                background-repeat: no-repeat;
                background-position: center;
                background-size: contain;
                cursor: zoom-in;">
        </div>

        <div class="d-flex justify-content-center gap-3 mt-4">
            @if (Model.PlateIndex > 1)
            {
                <a asp-area="Ptg"
                   asp-page="PlateDetail"
                   asp-page-handler="Plate"
                   asp-route-id="@Model.StandId"
                   asp-route-plate="@(Model.PlateIndex - 1)"
                   class="btn btn-outline-primary pager prev"
                   data-ajax="true"
                   data-ajax-method="get"
                   data-ajax-update="#plate-content"
                   data-ajax-mode="replace">◀ Předchozí</a>
            }
            @if (Model.PlateIndex < Model.TotalPlates)
            {
                <a asp-area="Ptg"
                   asp-page="PlateDetail"
                   asp-page-handler="Plate"
                   asp-route-id="@Model.StandId"
                   asp-route-plate="@(Model.PlateIndex + 1)"
                   class="btn btn-outline-primary pager next"
                   data-ajax="true"
                   data-ajax-method="get"
                   data-ajax-update="#plate-content"
                   data-ajax-mode="replace">Další ▶</a>
            }
        </div>
    </div>

    <!-- Tabulka: pořadí, reg_number, name, price + ikonka náhledu -->
    <div class="col-md-8">
        @if (Model.Items.Any())
        {
            var lightboxGroup = $"plate_{Model.StandId}_{Model.PlateIndex}";
            var uniqueImages = Model.Items
            .Where(x => x.HasImage && !string.IsNullOrEmpty(x.ImgUrl))
            .GroupBy(x => x.ImgUrl!)
            .Select(g => new { ImgUrl = g.Key, Title = $"{g.First().RegNumber} <br/> {g.First().TagName}" })
            .ToList();

            <!-- skrytý seznam JEN unikátních odkazů pro Lightbox -->
            <div class="d-none" id="lb-uniques-@Model.StandId-@Model.PlateIndex">
                @foreach (var u in uniqueImages)
                {
                    <a href="@u.ImgUrl" data-lightbox="@lightboxGroup" data-title="@u.Title"></a>
                }
            </div>

            <ul class="nav nav-tabs" id="itemsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab" aria-controls="list-pane" aria-selected="false">
                        Seznam
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="thumbs-tab" data-bs-toggle="tab" data-bs-target="#thumbs-pane" type="button" role="tab" aria-controls="thumbs-pane" aria-selected="false">
                        Náhledy
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="thumbs-tab" data-bs-toggle="tab" data-bs-target="#vo-pane" type="button" role="tab" aria-controls="vo-pane" aria-selected="false">
                        VO @(Model.StandType == (int)StandType.Plate ? "štítek" : "cenovka")
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="thumbs-tab" data-bs-toggle="tab" data-bs-target="#mo-pane" type="button" role="tab" aria-controls="mo-pane" aria-selected="false">
                        MO @(Model.StandType == (int)StandType.Plate ? "štítek" : "cenovka")
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3" id="itemsTabContent">
                <div class="tab-pane fade" id="list-pane" role="tabpanel" aria-labelledby="list-tab">
                    <table class="table table-sm table-bordered align-middle plate-item">
                        <tbody>
                            @{
                                var orderByReg = new Dictionary<string, int>();
                                var currentOrder = 1;
                                var items = Model.Items /* volitelné: */.OrderBy(i => i.ItemOrder);
                            }

                            @foreach (var item in items)
                            {
                                int? displayOrder = null;

                                var regKey = item.RegNumber?.ToString();
                                if (!string.IsNullOrWhiteSpace(regKey))
                                {
                                    if (!orderByReg.TryGetValue(regKey, out var num))
                                    {
                                        num = currentOrder++;
                                        orderByReg[regKey] = num;
                                    }
                                    displayOrder = num;
                                }

                                <tr>
                                    <td class="item-order">
                                        <span class="order-dot">@((displayOrder.HasValue) ? displayOrder.Value.ToString() : "")</span>
                                    </td>
                                    <td class="name">
                                        <a href="@($"https://www.koupelny-jas.cz/eshop/p/{TextUtils.Slugify(item.TagName!)}-i{item.RegNumber}")" target="_blank">
                                            @item.TagName
                                        </a>
                                    </td>
                                    <td class="price">@((item.Price.HasValue) ? $"{item.Price:N0} {item.Unit}" : "")</td>
                                    <td class="reg">@item.RegNumber</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="thumbs-pane" role="tabpanel" aria-labelledby="thumbs-tab">
                    @if (uniqueImages.Any())
                    {

                        <div class="row row-cols-2 row-cols-md-3 g-2">
                            @foreach (var u in uniqueImages)
                            {
                                <div class="col">
                                    <div class="image-hover">
                                        <a href="@u.ImgUrl" data-lightbox="@lightboxGroup" data-title="@u.Title">
                                            <img src="@u.ImgUrl"
                                                 alt="@u.Title"
                                                 class="img-fluid rounded border"
                                                 style="box-shadow: 0 .25rem .75rem rgba(0,0,0,.4), 0 1rem 2rem rgba(0,0,0,.25);" />
                                            <div class="overlay">@Html.Raw(u.Title)</div>
                                        </a>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Žádné náhledy.</p>
                    }
                </div>
                <div class="tab-pane fade" id="vo-pane" role="tabpanel" aria-labelledby="vo-pane">
                    @if (Model.StandType == (int)StandType.Plate)
                    {
                        @Html.DisplayFor(m => m.Items, "PlatePriceTag", additionalViewData: new { VoTag = true })
                    }
                    else
                    {
                        <div class="row gx-4 gy-4">
                            @Html.DisplayFor(m => m.Items, "PiecePriceTag", additionalViewData: new { VoTag = true })
                        </div>
                    }
                </div>
                <div class="tab-pane fade" id="mo-pane" role="tabpanel" aria-labelledby="mo-pane">
                    @if (Model.StandType == (int)StandType.Plate)
                    {
                        @Html.DisplayFor(m => m.Items, "PlatePriceTag", additionalViewData: new { VoTag = false })
                    }
                    else
                    {
                        <div class="row gx-4 gy-4">
                            @Html.DisplayFor(m => m.Items, "PiecePriceTag", additionalViewData: new { VoTag = false })
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <p class="text-muted">Žádné položky na tomto platu.</p>
        }
    </div>
</div>

<!-- Bootstrap modal pro MAX zvětšení -->
<div class="modal fade" id="plateModal" tabindex="-1" aria-labelledby="plateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen">
        <div class="modal-content" style="background-color: #222;">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Zavřít"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center" style="overflow:auto;">
                <img id="plateModalImg"
                     src="@Model.ImgUrl"
                     alt="Plato detail"
                     style="max-width:none; height:auto;" />
            </div>
        </div>
    </div>
</div>
