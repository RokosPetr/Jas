@model Jas.Areas.Ptg.Pages.StandPrintModel

@{
    Layout = null;
}

@{
    ViewData["PrintQr"] = Model.PrintQr;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    @{
        var cssPath = System.IO.Path.Combine(Directory.GetCurrentDirectory(), "wwwroot/css/ptg-plate-tag.min.css");
        var css = System.IO.File.ReadAllText(cssPath);

        var match = System.Text.RegularExpressions.Regex.Match(css, @"--ptg-plate-padding\s*:\s*([^;]+);");
        if (match.Success)
        {
            var paddingValue = match.Groups[1].Value.Trim();

            css = System.Text.RegularExpressions.Regex.Replace(css, @"var\(--ptg-plate-padding\)", paddingValue);
        }
    }
    <style>
        @Html.Raw(css)
    </style>
</head>
<body class="ptg-print">

    @if (Model.PrintPictures)
    {
        <div class="front-page">
            <div class="picture"><img src="@Model.Stand.Picture" /></div>
            <div class="plates">
                <table>
                    <tr>
                        <th></th>
                        <th>@Model.Stand.Name</th>
                    </tr>
                    @foreach (var item in Model.Plates.OrderBy(o => o.PlateOrder))
                    {
                        <tr>
                            <td>@item.PlateOrder@Html.Raw(".")</td>
                            <td>@item.Description</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
        <div class="front-page">&nbsp;</div>
    }

    @{
        var plates      = Model.Plates;
        var platesCount = plates.Count;
        var i           = 0;
        var limit       = Model.PrintQr ? 12 : 15;
        var twoMode     = false; // false = 4 na stránku (2x2), true = 2 na stránku (1x2)
    }

    @while (i < platesCount)
    {
        int baseIndex = i;
        int pageSize;
        int nextIndex;
        bool pageTwoMode; // layout jen pro tuto stránku
        var batch = new List<Jas.Models.Ptg.Plate>();

        if (!twoMode)
        {
            // pokus o stránku po 4 (2x2) – zkontrolujeme, jestli v téhle várce je nějaká "velká"
            int checkCount = Math.Min(4, platesCount - baseIndex);
            int firstOversizedOffset = -1;

            for (int offset = 0; offset < checkCount; offset++)
            {
                var p = plates[baseIndex + offset];
                int units = p.ProductGroupCount + p.RegNumberCount;

                if (units > limit)
                {
                    firstOversizedOffset = offset;
                    break;
                }
            }

            if (firstOversizedOffset == -1)
            {
                // žádná nadrozměrná v této várce → normálně 2x2, až 4 kusy
                pageSize    = checkCount;
                pageTwoMode = false;
                batch       = plates.Skip(baseIndex).Take(pageSize).ToList();
                nextIndex   = baseIndex + pageSize;
            }
            else if (firstOversizedOffset == 0)
            {
                // první v této várce je nadrozměrná:
                //  - od této stránky jedeme po 2
                //  - vytiskneme ji (a případně další) v twoMode layoutu
                twoMode     = true;
                pageTwoMode = true;
                pageSize    = Math.Min(2, platesCount - baseIndex);
                batch       = plates.Skip(baseIndex).Take(pageSize).ToList();
                nextIndex   = baseIndex + pageSize;
            }
            else
            {
                // před nadrozměrnou jsou "normální" kusy →
                // ty vytiskneme ještě ve 4-režimu (2x2),
                // nadrozměrná se vytiskne v DALŠÍ iteraci už v twoMode.
                pageSize    = firstOversizedOffset;
                pageTwoMode = false;
                batch       = plates.Skip(baseIndex).Take(pageSize).ToList();

                twoMode   = true;                      // od příští stránky už po 2
                nextIndex = baseIndex + firstOversizedOffset; // PŘED nadrozměrnou (tu nevynecháme)
            }
        }
        else
        {
            // režim po 2 na stránku (1x2)
            pageSize    = Math.Min(2, platesCount - baseIndex);
            pageTwoMode = true;
            batch       = plates.Skip(baseIndex).Take(pageSize).ToList();
            nextIndex   = baseIndex + pageSize;
        }

        <table class="page">
            <tbody>
                @if (!pageTwoMode)
                {
                    // layout 2×2 (max 4 na stránku) – původní chování
                    var row = 0;
                    while (row < 2)
                    {
                        <tr>
                            @{
                                var col = 0;
                            }
                            @while (col < 2)
                            {
                                int idxInBatch    = row * 2 + col;
                                int absoluteIndex = baseIndex + idxInBatch;

                                if (idxInBatch < batch.Count)
                                {
                                    var plate = batch[idxInBatch];

                                    <td class="plate">
                                        @await Html.PartialAsync(
                                            "/Areas/Ptg/Pages/_PlateTag.cshtml",
                                            Model.PlateItems
                                                .Where(w => w.IdPlate == plate.IdPlate)
                                                .ToList(),
                                            ViewData
                                        )
                                    </td>
                                }
                                else
                                {
                                    <td></td>
                                }

                                col++;
                            }
                        </tr>

                        row++;
                    }
                }
                else
                {
                    // režim po 2: 1 řádek, max 2 plate na stránku
                    <tr>
                        @{
                            var idxInBatch = 0;
                        }
                        @while (idxInBatch < batch.Count)
                        {
                            var plate = batch[idxInBatch];

                            <td class="plate">
                                @await Html.PartialAsync(
                                    "/Areas/Ptg/Pages/_PlateTag.cshtml",
                                    Model.PlateItems
                                        .Where(w => w.IdPlate == plate.IdPlate)
                                        .ToList(),
                                    ViewData
                                )
                            </td>

                            idxInBatch++;
                        }

                        @if (batch.Count == 1)
                        {
                            <td></td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        @if (Model.PrintPictures)
        {
            <table class="page">
                <tbody>
                    @if (!pageTwoMode)
                    {
                        // layout 2×2 pro obrázky – původní chování
                        var row2 = 0;
                        while (row2 < 2)
                        {
                            <tr>
                                @{
                                    var col2 = 0;
                                }
                                @while (col2 < 2)
                                {
                                    int idxInBatch    = row2 * 2 + col2;
                                    int absoluteIndex = baseIndex + idxInBatch;

                                    if (idxInBatch < batch.Count)
                                    {
                                        int plateIndex = (absoluteIndex % 2 == 0 ? absoluteIndex + 1 : absoluteIndex - 1);
                                        if (plateIndex >= platesCount) plateIndex = platesCount - 1;

                                        <td>
                                            <table class="picture">
                                                <tr>
                                                    <td>
                                                        <span>@plates[plateIndex].PlateOrder.&nbsp;</span>
                                                        <span>@plates[plateIndex].Description</span>
                                                        <br />
                                                        <img src="@plates[plateIndex].Picture" />
                                                    </td>
                                                    <td class="reg">
                                                        @foreach (var item in Model.PlateItems.Where(w => w.IdPlate == plates[plateIndex].IdPlate).OrderBy(o => o.ItemOrder))
                                                        {
                                                            <span>@item.ItemOrder@Html.Raw(".") @item.RegNumber</span>
                                                            <br />
                                                        }
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    }
                                    else
                                    {
                                        <td></td>
                                    }

                                    col2++;
                                }
                            </tr>

                            row2++;
                        }
                    }
                    else
                    {
                        // režim po 2 pro obrázky: 1 řádek, max 2
                        <tr>
                            @{
                                var idx2 = 0;
                            }
                            @while (idx2 < batch.Count)
                            {
                                int absoluteIndex = baseIndex + idx2;
                                int plateIndex = (absoluteIndex % 2 == 0 ? absoluteIndex + 1 : absoluteIndex - 1);
                                if (plateIndex >= platesCount) plateIndex = platesCount - 1;

                                <td>
                                    <table class="picture">
                                        <tr>
                                            <td>
                                                <span>@plates[plateIndex].PlateOrder.&nbsp;</span>
                                                <span>@plates[plateIndex].Description</span>
                                                <br />
                                                <img src="@plates[plateIndex].Picture" />
                                            </td>
                                            <td class="reg">
                                                @foreach (var item in Model.PlateItems.Where(w => w.IdPlate == plates[plateIndex].IdPlate))
                                                {
                                                    <span>@item.ItemOrder@Html.Raw(".") @item.RegNumber</span>
                                                    <br />
                                                }
                                            </td>
                                        </tr>
                                    </table>
                                </td>

                                idx2++;
                            }

                            @if (batch.Count == 1)
                            {
                                <td></td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        }

        i = nextIndex;
    }

</body>
</html>
