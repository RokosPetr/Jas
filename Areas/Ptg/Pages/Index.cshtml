@page "/ptg/{Available:regex(expozice|portfolio)?}/{ProducerName?}"
@model Jas.Areas.Ptg.Pages.IndexModel
@{
    ViewData["Title"] = "Správa cenovek a štítků";
}

<style>
    .catalog-img {
    height: 150px;
    width: 100%;
    object-fit: contain;
    background-color: #f8f9fa;
    padding: 0.5rem;
    }
</style>

<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ul class="breadcrumb">
            <li class="breadcrumb-item">
                @if (string.Equals(Model.Available, "portfolio", StringComparison.OrdinalIgnoreCase))
                {
                    <a asp-area="Ptg"
                       asp-page="/Index"
                       asp-route-Available="portfolio"
                       asp-route-ProducerName="">Všechny stojany</a>
                }
                else
                {
                    <a asp-area="Ptg"
                       asp-page="/Index"
                       asp-route-Available="expozice"
                       asp-route-ProducerName="">Moje stojany</a>
                }
            </li>

            @if (!string.IsNullOrEmpty(Model.ProducerName))
            {
                <li class="breadcrumb-item active" aria-current="page">
                    @Model.ProducerName
                </li>
            }

            @if (!string.IsNullOrEmpty(Model.SearchString))
            {
                <li class="breadcrumb-item active" aria-current="page">
                    „@Model.SearchString“
                </li>
            }
        </ul>
    </nav>
<form method="get" class="mb-4 d-flex flex-column gap-2" role="search">
    <div class="d-flex justify-content-center align-items-center gap-2">
        <input type="text"
               name="SearchString"
               value="@Model.SearchString"
               class="form-control w-25"
               placeholder="Vyhledat..."
               id="searchBox"
               autocomplete="on" />

        <button type="submit" class="btn btn-primary">Hledat</button>

        @if (!string.IsNullOrWhiteSpace(Model.SearchString))
        {
            <a class="btn btn-outline-secondary"
               href="@Url.Page("Index", new { area = "Ptg", ProducerName = Model.ProducerName, Available = Model.Available })">
                Zrušit
            </a>
        }
    </div>

    <!-- ✅ filtry typů položek ve stojanu -->
    <div class="d-flex justify-content-center gap-4 mt-2">

        <!-- Obklady / Dlažby (typ 1,2) -->
        <div class="form-check">
            <input class="form-check-input stand-type-cb"
                   type="checkbox"
                   id="type12"
                   data-types="1,2"
                   @(Model.StandTypes.Contains(1) ? "checked" : "") />
            <label class="form-check-label" for="type12">
                Obklady / Dlažby (typ 1,2)
            </label>
        </div>

        <!-- Koupelnové vybavení (typ 3) -->
        <div class="form-check">
            <input class="form-check-input stand-type-cb"
                   type="checkbox"
                   id="type3"
                   data-types="3"
                   @(Model.StandTypes.Contains(3) ? "checked" : "") />
            <label class="form-check-label" for="type3">
                Koupelnové vybavení (typ 3)
            </label>
        </div>

    </div>

    <!-- sem budeme generovat StandTypes hidden inputs -->
    <div id="standTypesHidden"></div>

    <!-- ✅ zachovat ostatní filtry v URL -->
    <input type="hidden" name="Available" value="@Model.Available" />
    <input type="hidden" name="ProducerName" value="@Model.ProducerName" />
</form>
    <div class="d-flex flex-wrap justify-content-center gap-3 mb-4">
        @foreach (var producer in Model.Producers)
        {
            <a asp-area="Ptg"
               asp-page="/Index"
               asp-route-Available="@(Model.Available ?? "expozice")"
               asp-route-ProducerName="@(producer.Name)"
               class="text-decoration-none">
                @if(producer.Id != 0)
                {
                    <img src="/images/logos/@producer.LogoImage" alt="@producer.Name"
                         class="img-fluid" style="max-height: 60px;" />
                }
                else
                {
                    <span class="d-inline-flex align-items-center justify-content-center"
                          style="height:60px; min-width:60px; padding:0 .5rem; font-weight:800; color:black;">
                        MIX
                    </span>
                }
            </a>
        }
    </div>
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-4 g-4">
        @foreach (var item in Model.Stands)
        {
            <div class="col">
                <div class="card h-100 @(item.B2b ? "ptg-mo-stand" : "") @(item.B2c ? "ptg-vo-stand" : "")">
                    @if (item.ImgUrl == null)
                    {
                        <img src="/images/no-picture.png" class="card-img-top catalog-img" alt="@item.Name">
                    }
                    else
                    {
                        <a href="@item.ImgUrl" class="text-decoration-none text-dark" data-lightbox="img_@item.IdStand">
                            <img src="@item.ImgUrl" class="card-img-top catalog-img" alt="@item.Name">
                        </a>

                        @if (!string.IsNullOrEmpty(item.SecondPicture))
                        {
                            <a href="@item.SecondPicture" data-lightbox="img_@item.IdStand" class="d-none">
                                <img src="@item.SecondPicture" alt="" />
                            </a>
                        }
                    }
                    <div class="card-body text-center p-2">
                        <h6 class="card-title">@item.Code<br/>@item.Name</h6>
                    </div>
                    <div class="card-footer text-center bg-white border-0 pb-3">
                        @if (item.Type == 2)
                        {
                            <a asp-area="Ptg"
                               asp-page="PlateDetail"
                               asp-route-id="@item.IdStand"
                               asp-route-page="1"
                               asp-route-idplate="@item.IdPlate"
                               class="btn btn-sm btn-outline-primary me-2">
                                Detail
                            </a>
                        }
                        else
                        {
                            <a asp-area="Ptg"
                               asp-page="PieceDetail"
                               asp-route-id="@item.IdStand"
                               class="btn btn-sm btn-outline-primary me-2">
                                Detail
                            </a>
                        }
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Stáhnout PDF
                            </button>
                            <ul class="dropdown-menu">
                                @if (item.B2b)
                                {
                                    <li>
                                        @if (item.PiecePriceTag)
                                        {
                                            <a class="dropdown-item" href="https://www.koupelnyprokazdeho.cz/PriceTag?company=partneri&catalog=cenovky-vo&idStand=@item.IdMkStand" download>
                                                VO cenovka
                                            </a>
                                        }
                                        @if (item.PlatePriceTag)
                                        {
                                            <a class="dropdown-item" href="https://www.koupelnyprokazdeho.cz/PriceTagPlate?company=partneri&idMkStand=@item.IdMkStand" download>
                                                VO cenovka
                                            </a>
                                        }
                                    </li>
                                }
                                @if (item.B2c)
                                {
                                    <li>
                                        @if (item.PiecePriceTag)
                                        {
                                            <a class="dropdown-item" href="https://www.koupelnyprokazdeho.cz/PriceTag?company=koupelny-jas&catalog=cenovky-mo&idStand=@item.IdMkStand" download>
                                                MO cenovka
                                            </a>
                                        }
                                        @if (item.PlatePriceTag)
                                        {
                                            <a class="dropdown-item" href="https://www.koupelnyprokazdeho.cz/PriceTagPlate?company=koupelny-jas&idMkStand=@item.IdMkStand" download>
                                                MO cenovka
                                            </a>
                                        }
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(function () {

            let currentRequest = null;

            // default: jen moje stojany podle Model.Available
            let onlyMyStands = @((Model.Available == "expozice").ToString().ToLower());

            $("#searchBox").autocomplete({
                minLength: 3,
                source: function (request, response) {

                    if (currentRequest) {
                        currentRequest.abort();
                        currentRequest = null;
                    }

                    currentRequest = $.ajax({
                        url: "@Url.Page("Index", new { area = "Ptg", handler = "Search" })",
                        type: "GET",
                        data: {
                            q: request.term,
                            onlyMine: onlyMyStands
                        },
                        success: function (data) {
                            currentRequest = null;

                            let items = data || [];

                            // 🔴 TRIK: pokud nic nepřišlo, nacpeme 1 dummy položku,
                            // aby autocomplete otevřel menu a zavolal _renderMenu
                            if (items.length === 0) {
                                items = [{ __empty: true }];
                            }

                            response(items);
                        },
                        error: function (xhr, status) {
                            if (status !== "abort") console.error(status);
                            currentRequest = null;
                        }
                    });
                },
                select: function (event, ui) {
                    // ignorujeme dummy položku (prázdný výsledek) i případné "filter" položky
                    if (ui.item.__empty) {
                        return false;
                    }

                    if (ui.item.url) {
                        window.location.href = ui.item.url;
                        return false;
                    }

                    if (ui.item.value) {
                        $("#searchBox").val(ui.item.value);
                    }

                    return false;
                }
            });

            // 🔵 vlastní _renderMenu: vždy checkbox + případné výsledky / info
            $("#searchBox").autocomplete("instance")._renderMenu = function (ul, items) {
                const self = this;

                // 1) checkbox "Jen moje stojany"
                const id = "chkOnlyMyStands";
                const $liFilter = $("<li>")
                    .addClass("ui-autocomplete-filter")
                    .appendTo(ul);

                const $wrapper = $("<div>")
                    .addClass("px-2 py-1 d-flex align-items-center gap-2");

                const $cb = $("<input>", {
                    type: "checkbox",
                    id: id,
                    checked: onlyMyStands
                });

                const $label = $("<label>", {
                    for: id,
                    text: "Jen moje stojany"
                });

                $wrapper.append($cb).append($label);
                $liFilter.append($wrapper);

                $cb.off("change").on("change", function () {
                    onlyMyStands = this.checked;
                    // znovu spustíme hledání se stejným textem
                    $("#searchBox").autocomplete("search", $("#searchBox").val());
                });

                // 2) pokud máme jen dummy položku → žádné výsledky
                if (items.length === 1 && items[0].__empty) {
                    $("<li>")
                        .addClass("px-2 py-1 text-muted")
                        .text("Žádné výsledky…")
                        .appendTo(ul);
                    return;
                }

                // 3) normální render položek
                $.each(items, function (index, item) {
                    self._renderItemData(ul, item);
                });
            };
        });

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form[role='search']");
            const hiddenContainer = document.getElementById("standTypesHidden");
            const checkboxes = document.querySelectorAll(".stand-type-cb");

            function rebuildStandTypesHidden() {
                hiddenContainer.innerHTML = "";

                checkboxes.forEach(cb => {
                    if (!cb.checked) return;

                    const types = cb.dataset.types.split(",");
                    types.forEach(t => {
                        const input = document.createElement("input");
                        input.type = "hidden";
                        input.name = "StandTypes";
                        input.value = t;
                        hiddenContainer.appendChild(input);
                    });
                });
            }

            rebuildStandTypesHidden();

            checkboxes.forEach(cb => {
                cb.addEventListener("change", function () {
                    rebuildStandTypesHidden();
                    form.submit();
                });
            });
        });
    </script>
}
